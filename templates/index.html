<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>リアルタイムチャット</title>
    <style>
        body { font-family: sans-serif; }
        .chat-container { max-width: 800px; margin: auto; }
        #messages { list-style-type: none; margin: 0; padding: 0; border: 1px solid #ccc; height: 400px; overflow-y: scroll; margin-bottom: 10px; }
        #messages li { padding: 8px 12px; }
        #messages li:nth-child(odd) { background: #f1f1f1; }
        #messages li.status { color: #888; font-style: italic; }
        #messages li .timestamp { font-size: 0.8em; color: #777; margin-left: 10px; } /* タイムスタンプ用のスタイル */
        #form { display: flex; }
        #message_input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; }
        #form button { background: #007bff; color: white; padding: 10px; border: none; cursor: pointer; }
        #room-title { margin-bottom: 10px; }
        .search-controls {
            padding: 10px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-controls input {
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h1 id="room-title">チャットルーム</h1>

        <form id="search-form" class="search-controls">
            <input type="text" id="search-keyword" placeholder="キーワード">
            <label for="start-date">期間:</label>
            <input type="date" id="start-date">
            <span>〜</span>
            <input type="date" id="end-date">
            <button type="submit">履歴を検索</button>
        </form>

        <ul id="messages"></ul>

        <form id="form" action="">
            <input id="message_input" autocomplete="off" placeholder="メッセージを入力..." required />
            <button>送信</button>
        </form>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // --- ページ読み込み時の初期設定 ---
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        const room = urlParams.get('room');
        document.getElementById('room-title').textContent = `チャットルーム: ${room}`;
        const socket = io();

        socket.on('connect', function() {
            socket.emit('join', {
                'username': username,
                'room': room
            });
            // 接続時に自動で全履歴を読み込むのをやめる
        });

        // --- HTML要素の取得 ---
        const form = document.getElementById('form');
        const messageInput = document.getElementById('message_input');
        const messages = document.getElementById('messages');
        const searchForm = document.getElementById('search-form');

        // --- イベントハンドラ ---
        form.addEventListener('submit', function(e) { /* (変更なし) */
            e.preventDefault();
            if (messageInput.value) {
                socket.emit('send_message', {
                    'username': username,
                    'message': messageInput.value,
                    'room': room
                });
                messageInput.value = '';
            }
        });

        // メッセージ表示を関数化
        function addMessage(data) {
            const item = document.createElement('li');
            const strong = document.createElement('strong');
            strong.textContent = data.username;
            
            const time = document.createElement('span');
            time.className = 'timestamp';
            time.textContent = data.timestamp;

            item.appendChild(strong);
            item.append(`: ${data.message}`);
            item.appendChild(time); // タイムスタンプを追加
            messages.appendChild(item);
        }

        socket.on('broadcast_message', function(data) {
            addMessage(data); // 関数を呼び出す
            messages.scrollTop = messages.scrollHeight;
        });
        
        socket.on('load_history', function(history) {
            messages.innerHTML = ''; // 履歴表示の前にクリア
            history.forEach(function(data) {
                addMessage(data); // 関数を呼び出す
            });
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('status', function(data) { /* (変更なし) */
            const item = document.createElement('li');
            item.className = 'status';
            item.textContent = data.msg;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });
        
        searchForm.addEventListener('submit', function(e) { /* (変更なし) */
            e.preventDefault();
            const keyword = document.getElementById('search-keyword').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            socket.emit('search_history', {
                'room': room,
                'keyword': keyword,
                'start_date': startDate,
                'end_date': endDate
            });
        });
    </script>
</body>
</html>